## Codebase Patterns

(Add patterns discovered during development here. Future iterations will read this first.)

- Use Vector3i for grid positions (x, y = horizontal, z = floor level)
- All block types defined in data/blocks.json, not hardcoded
- Sprites go in assets/sprites/blocks/{category}/
- Signals over polling: blocks emit signals, systems connect to them
- Balance numbers loaded from data/balance.json at runtime
- AutoLoad scripts must NOT have class_name (use autoload name instead)
- Access autoloads via get_root().get_node("/root/AutoloadName")

---

## Iteration Log

(Ralph will append learnings after each iteration below)

## Iteration 1 - 2026-01-25
Task: arcology-4ct.1 - Create Godot 4 project structure
Status: PASSED
Changes:
- project.godot: Godot 4.3 config with input mappings
- scenes/main.tscn: Entry scene with Camera2D, World, UI
- src/core/main.gd: Camera pan/zoom controls
Learnings:
- Godot 4 uses config_version=5
- Camera2D zoom needs matching Vector2 components

## Iteration 2 - 2026-01-25
Task: arcology-4ct.2 - Add placeholder sprite
Status: PASSED
Changes:
- assets/sprites/blocks/placeholder.svg: 64x32 isometric diamond
- scenes/main.tscn: Added PlaceholderSprite node
Learnings:
- SVG works well for placeholder sprites in Godot 4

## Iteration 3 - 2026-01-25
Task: arcology-x0d.1 - Implement Grid class
Status: PASSED
Changes:
- src/core/grid.gd: Grid class with sparse 3D dictionary, isometric conversion, signals
- test/test_grid.gd: Unit tests for Grid class
Learnings:
- Grid extends Node (not RefCounted) so it can be added to scene tree
- Use roundi() for screen_to_grid to handle floating point precision
- TILE_DEPTH (32) is diamond height, FLOOR_HEIGHT (32) is Z offset
- grid_to_screen formula: x = (pos.x - pos.y) * 32, y = (pos.x + pos.y) * 16 - pos.z * 32
- screen_to_grid requires known Z level to invert correctly

## Iteration 4 - 2026-01-25
Task: arcology-x0d.4 - Create blocks.json data file
Status: PASSED
Changes:
- data/blocks.json: 6 block types for M1-M3
Learnings:
- Block schema: name, category, traversability, size, cost, sprite, connects_horizontal, connects_vertical
- entrance has ground_only: true (can only be placed on Z=0)
- stairs connects to Z+1 only; elevator connects full shaft
- private blocks (residential/commercial) have connects_horizontal: false

## Iteration 5 - 2026-01-25
Task: arcology-x0d.2 - Implement Block base class
Status: PASSED
Changes:
- src/blocks/block.gd: Block RefCounted class
- test/test_block.gd: Unit tests
Learnings:
- Block extends RefCounted (not Node) for lightweight data storage
- get_definition() looks up BlockRegistry via Engine.get_main_loop().get_node()
- property_changed signal uses property name string for reactive updates
- Graceful fallback when BlockRegistry not available (returns empty dict)
- Must run --import to generate .uid files for new scripts

## Iteration 6 - 2026-01-25
Task: arcology-x0d.3 - Implement BlockRegistry
Status: PASSED
Changes:
- src/core/block_registry.gd: BlockRegistry autoload
- project.godot: Added BlockRegistry to [autoload] section
- test/test_block_registry.gd: Unit tests
Learnings:
- AutoLoad scripts must NOT have class_name (conflicts with singleton name)
- Access autoload via get_root().get_node("/root/BlockRegistry")
- JSON.parse() returns error code, use get_data() for parsed result
- Helper methods (is_public, connects_vertical, etc.) keep Block class simple

## Iteration 7 - 2026-01-25
Task: arcology-x0d.8 - Create basic block sprites
Status: PASSED
Changes:
- assets/sprites/blocks/*.png: 6 isometric block sprites
- scripts/generate_sprites.py: Python sprite generator
Learnings:
- Pillow (PIL) can generate isometric sprites programmatically
- 64x64 hexagonal shape: top diamond + left wall + right wall
- Use RGBA mode for transparency
- Keep generator script for easy regeneration with different colors

## Iteration 8 - 2026-01-25
Task: arcology-x0d.5 - Setup isometric rendering with Y-sort
Status: PASSED
Changes:
- src/core/block_renderer.gd: BlockRenderer class for sprite management
- src/core/main.gd: Setup grid and renderer, test blocks
- scenes/main.tscn: Removed placeholder sprite
- test/test_renderer.gd: Unit tests
Learnings:
- BlockRenderer extends Node2D with y_sort_enabled = true
- Connect to Grid signals for reactive sprite creation/removal
- z_index formula: x + y + z*100 ensures proper floor stacking
- Cache loaded textures to avoid repeated load() calls
- Block types in code must match blocks.json keys exactly

## Iteration 9 - 2026-01-25
Task: arcology-x0d.6 - Implement block placement on click
Docs Consulted:
- documentation/quick-reference/isometric-math.md (screen_to_grid, mouse picking)
- documentation/architecture/milestones/milestone-1-grid-blocks.md (input handling)
Status: PASSED
Changes:
- src/core/input_handler.gd: InputHandler class for mouse input
- src/core/main.gd: Integrated InputHandler with setup
- test/test_input_handler.gd: Unit tests for placement/removal
Learnings:
- Use camera.get_canvas_transform().affine_inverse() * mouse_pos for world coords
- Ghost sprite needs z_index=1000 to always render on top
- Ghost modulate with Color(1,1,1,0.6) for valid, Color(1,0.3,0.3,0.6) for invalid
- _unhandled_input receives mouse events; _process handles ghost position updates
- Tests can run without scene tree if BlockRegistry lookup gracefully fails

## Iteration 10 - 2026-01-25
Task: arcology-x0d.7 - Create simple block picker UI
Docs Consulted:
- documentation/architecture/milestones/milestone-1-grid-blocks.md (UI requirements)
- documentation/game-design/blocks/README.md (block categories)
Status: PASSED
Changes:
- src/ui/block_picker.gd: BlockPicker Control class with HBoxContainer
- src/core/main.gd: Integrated BlockPicker with ui_layer
- test/test_block_picker.gd: Unit tests for selection
Learnings:
- Control anchors: anchor_top=1.0, anchor_bottom=1.0, offset_top=-60 for bottom panel
- Use toggle_mode=true on Button for visual pressed state
- Define BLOCK_ORDER constant array for consistent keyboard shortcuts (1-6)
- call_deferred("_populate_buttons") to wait for BlockRegistry autoload
- Connect block_type_selected signal to InputHandler.set_selected_block_type()

## Iteration 11 - 2026-01-25
Task: arcology-y6e.1 - Add floor selector UI
Docs Consulted:
- documentation/architecture/milestones/milestone-2-floor-navigation.md (Floor system spec)
Status: PASSED
Changes:
- src/core/game_state.gd: GameState autoload with floor state and signals
- src/ui/floor_selector.gd: FloorSelector UI with label and up/down buttons
- src/core/input_handler.gd: Now reads current_floor from GameState
- src/core/main.gd: Integrated FloorSelector with UI layer
- project.godot: Added GameState to autoloads
- test/test_game_state.gd: Unit tests for GameState
- test/test_floor_selector.gd: Unit tests for FloorSelector
Learnings:
- GameState autoload centralizes floor state for all systems
- FloorSelector handles PageUp/PageDown in _unhandled_input
- InputHandler gets current_floor via _get_current_floor() helper
- KEY_PAGEUP and KEY_PAGEDOWN are the keycode constants
- get_tree().get_root().get_node_or_null() for safe autoload access
Followup:
- Floor visibility (hiding floors above, fading floors below) is a separate task (y6e.2)

## Iteration 12 - 2026-01-25
Task: arcology-y6e.2 - Implement floor visibility system
Docs Consulted:
- documentation/architecture/milestones/milestone-2-floor-navigation.md (Visibility code sample)
- documentation/game-design/core-concepts.md (Z-level meaning)
Status: PASSED
Changes:
- src/core/block_renderer.gd: Added update_visibility() with cutaway view logic
- src/core/main.gd: Connected GameState.floor_changed to update visibility
- test/test_floor_visibility.gd: 8 unit tests (positive and negative assertions)
Learnings:
- Floor visibility constants: FLOORS_BELOW_VISIBLE=2, OPACITY_FALLOFF=0.3
- Opacity formula: 1.0 - (depth * 0.3) gives 100%, 70%, 40% for floors 0, -1, -2
- Connect to GameState.floor_changed signal for reactive updates
- Apply visibility to newly added blocks in _on_block_added handler
- Use get_node_or_null() for safe autoload access in methods called during initialization
Followup:
- Block placement on any floor (y6e.3) is next task in M2

## Iteration 13 - 2026-01-25
Task: arcology-y6e.3 - Enable block placement on any floor
Docs Consulted:
- documentation/architecture/milestones/milestone-2-floor-navigation.md (Placement on current floor)
- documentation/quick-reference/isometric-math.md (screen_to_grid with Z)
Status: PASSED
Changes:
- test/test_input_handler.gd: Fixed _test_floor_change to reflect GameState architecture
- test/test_multifloor_placement.gd: New integration test (8 tests) for multi-floor placement
Learnings:
- Feature was already implemented in InputHandler._get_current_floor() from y6e.1
- InputHandler reads current_floor from GameState autoload, not from own property
- Tests should use autoload integration tests for full coverage
- Test file test_multifloor_placement.gd covers: tower building, z-index ordering, entrance constraints
Followup:
- M2 Floor Navigation is now complete
- Next: M3 Connectivity tasks (adjacency detection, entrance block type)

## Iteration 14 - 2026-01-25
Task: arcology-itx.1 - Implement adjacency detection
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (Neighbor finding, connection rules)
- data/blocks.json (traversability, connects_horizontal/vertical properties)
Status: PASSED
Changes:
- src/core/grid.gd: Added adjacency methods
  - get_occupied_neighbors(): Returns neighbors with blocks
  - get_occupied_horizontal_neighbors(): Same floor only
  - can_connect(): Check walkability between blocks
  - get_walkable_neighbors(): Get reachable neighbors
- test/test_adjacency.gd: 12 unit tests
Learnings:
- Horizontal connection rule: at least one block must be public (traversable)
- Vertical connection rule: both blocks must have connects_vertical=true
- Private blocks are destinations, not through-routes (can reach, not traverse)
- Use explicit type annotations (: bool, : int) when calling registry methods to avoid type inference errors
- Registry methods return dynamic types, use explicit types not :=
Followup:
- Next M3 task: arcology-itx.3 (Add entrance block type)

## Iteration 15 - 2026-01-25
Task: arcology-itx.3 - Add entrance block type
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (Entrance as flood-fill seed)
- data/blocks.json (entrance definition already existed)
Status: PASSED
Changes:
- src/core/grid.gd: Added entrance tracking
  - _entrance_positions array tracks all entrance blocks
  - entrances_changed signal for connectivity recalculation
  - get_entrance_positions(), has_entrance() accessors
  - _track_entrance/_untrack_entrance on block add/remove
- test/test_entrance.gd: 10 unit tests
Learnings:
- Entrance block was already defined in blocks.json from iteration 4
- Ground_only enforcement was already in InputHandler
- Need to handle both Block objects and Dictionaries in tracking (for test compatibility)
- Use "block is Object and 'block_type' in block" pattern for safe property access
Followup:
- M3 flood-fill connectivity (itx.2) depends on this entrance tracking
- Next: Check remaining M3 tasks or continue with available tasks

## Iteration 16 - 2026-01-25
Task: arcology-itx.2 - Implement connectivity flood-fill
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (BFS algorithm, traversability rules)
- documentation/game-design/core-concepts.md (public vs private blocks)
- data/blocks.json (block type definitions)
Status: PASSED
Changes:
- src/core/grid.gd: Added BFS flood-fill connectivity algorithm
  - calculate_connectivity() performs BFS from all entrance positions
  - _is_block_public() checks traversability via registry or dict field
  - _set_block_connected() handles both Block objects and dictionaries
  - connectivity_changed signal for reactive updates
  - block_registry property for direct injection (testing)
  - Auto-recalculates on block add/remove via call_deferred
- test/test_connectivity.gd: 33 unit tests for BFS algorithm
- test/test_connectivity_integration.gd: 15 integration tests with BlockRegistry
Learnings:
- Traversability rules: PUBLIC blocks expand neighbors in BFS; PRIVATE blocks are destinations only
- Engine.get_main_loop() returns null inside SceneTree test scripts during _init
- For integration tests, set grid.block_registry directly rather than relying on autoload lookup
- When registry unavailable, check for explicit "traversability" field in Dictionary blocks
- Use call_deferred("calculate_connectivity") to ensure signals fire before recalc
Followup:
- M3 remaining tasks: visual feedback for unconnected blocks (warning icon, overlay)
- Elevator shaft connectivity needs stairs/elevator blocks tested thoroughly

## Iteration 17 - 2026-01-25
Task: arcology-itx.4 - Show connectivity warning on disconnected blocks
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (visual feedback section)
Status: PASSED
Changes:
- src/core/block_renderer.gd: Added connectivity visual feedback
  - DISCONNECTED_TINT (red) and CONNECTED_TINT (white) constants
  - _on_connectivity_changed() connects to Grid signal
  - _update_connectivity_visual() applies tint based on block.connected
  - _update_sprite_visibility() preserves connectivity tint when updating alpha
- test/test_connectivity_visuals.gd: 10 unit tests for visual feedback
Learnings:
- Color modulate combines RGB tint with alpha for floor visibility
- Connect to Grid.connectivity_changed signal for reactive updates
- Type annotations required for inferred types like `var x := something.property`
Followup:
- Optional: Add 'C' key toggle for full connectivity overlay mode
- M3 complete: stairs and elevator already implemented in earlier iterations

## Iteration 18 - 2026-01-25
Task: arcology-itx.5 and arcology-itx.6 - Stairs and Elevator block types
Status: ALREADY IMPLEMENTED
Notes:
- Both block types already exist in data/blocks.json from iteration 4
- Sprites exist in assets/sprites/blocks/
- Vertical connectivity tested in test_connectivity_integration.gd
- Closed both tasks as already complete

M3 Connectivity & Paths COMPLETE:
- itx.1: Adjacency detection ✓
- itx.2: Connectivity flood-fill ✓
- itx.3: Entrance block type ✓
- itx.4: Connectivity visual warning ✓
- itx.5: Stairs block type ✓
- itx.6: Elevator shaft block type ✓

## Iteration 19 - 2026-01-25
Task: arcology-ak9.1 - Implement Terrain class with base plane rendering
Docs Consulted:
- documentation/game-design/environment/terrain.md (theme colors, z-index layers)
- documentation/quick-reference/isometric-math.md (sprite dimensions)
Status: PASSED
Changes:
- src/core/terrain.gd: New Terrain class extending Node2D
  - theme property with setter (earth, mars, space)
  - THEME_COLORS constant with Color values
  - Z_INDEX constants (background=-2000, base=-1000)
  - Base plane ColorRect at z_index -1000
  - Background ColorRect at z_index -2000
  - get_theme_color(), is_valid_theme(), get_available_themes()
  - set_plane_size() for map customization
- test/test_terrain.gd: 12 unit tests (positive and negative)
Learnings:
- ColorRect z_index is relative to parent when child
- Use setter with validation for theme property
- Space theme needs transparent Color(0,0,0,0) for base plane
- push_warning() for invalid theme input (not error)

## Iteration 20 - 2026-01-25
Task: arcology-j61 - UX: Build mode floor feedback and auto-stacking
Docs Consulted:
- documentation/architecture/milestones/milestone-2-floor-navigation.md
- src/core/input_handler.gd, block_renderer.gd, game_state.gd, grid.gd
Status: PASSED
Changes:
- src/core/input_handler.gd:
  - _floor_label: Label showing "Z: N" near ghost preview
  - FLOOR_LABEL_OFFSET for positioning label relative to ghost
  - _create_floor_label() with shadow styling for visibility
  - Shift+click auto-stacking in _handle_mouse_button()
  - _get_auto_stack_position() finds highest Z and returns Z+1
  - Ghost preview shows auto-stack position when Shift held
  - Label shows "(auto)" suffix during Shift preview
- src/core/grid.gd:
  - get_highest_z_at(x, y) returns highest Z at column or -1 if empty
- test/test_floor_feedback.gd: 9 unit tests for new functionality
Learnings:
- get_tree() returns null in SceneTree unit tests during _init
- Use "var tree := get_tree(); if tree:" pattern for safe access
- Input.is_key_pressed(KEY_SHIFT) for checking modifier in _process
- Label z_index works relative to parent, set to 1001 (above ghost at 1000)
- add_theme_color_override for font_shadow_color gives readable labels

## Iteration 21 - 2026-01-25
Task: arcology-ak9.4 - Create terrain.json data file
Docs Consulted:
- documentation/game-design/environment/terrain.md (data schema, theme configs)
- documentation/game-design/scenarios.md (scenario parameters)
Status: PASSED
Changes:
- data/terrain.json: Theme configurations for earth, mars, space
  - base_color, background_color for each theme
  - decorations array with type, weight, size
  - decoration_density, has_river, background sprite path
- src/core/terrain.gd: Refactored to load from JSON
  - _load_terrain_data() parses JSON file on _init
  - _get_theme_data(), _get_base_color(), _get_background_color()
  - Added getters: get_decorations_config(), get_decoration_density()
  - Added getters: has_river(), get_background_sprite()
  - FALLBACK_THEME_COLORS and FALLBACK_BACKGROUND_COLORS if JSON missing
  - get_available_themes() now instance method (reads from loaded data)
- test/test_terrain.gd: 19 tests (original 12 + 7 new JSON tests)
Learnings:
- JSON.parse() returns error code, use get_data() for actual parsed result
- FileAccess.file_exists() to check before opening
- is_equal_approx() for float comparison in tests
- Keep static is_valid_theme() for convenience but it only checks fallbacks
- Instance method get_available_themes() can read from loaded JSON data

## Iteration 22 - 2026-01-25
Task: arcology-ak9.2 - Create terrain decoration sprites (Earth theme)
Docs Consulted:
- documentation/game-design/environment/terrain.md (sprite dimensions, decoration types)
- documentation/quick-reference/isometric-math.md (sprite geometry)
Status: PASSED
Changes:
- assets/sprites/terrain/earth/*.png: 6 decoration sprites
  - tree_oak.png (64x64): Deciduous tree with elliptical foliage
  - tree_pine.png (64x64): Conifer with layered triangular branches
  - rock_small.png (64x64): Irregular 1x1 boulder with lighting
  - rock_large.png (128x96): Large 2x2 rock formation
  - bush.png (64x64): Low rounded shrub
  - flowers.png (64x64): Colorful flower patch on grass diamond
- scripts/generate_terrain_sprites.py: Python sprite generator using Pillow
- test/test_terrain_sprites.gd: 10 unit tests for sprite loading
Learnings:
- Pillow can generate isometric sprites programmatically for consistent style
- 2x2 sprites use 128x96 dimensions (2x TILE_WIDTH, 1.5x TILE_HEIGHT)
- Must run `godot --headless --import` before tests can load new PNG files
- Use explicit type annotations in for loops (e.g., `var path: String = ...`)
- RGBA format with transparent pixels allows compositing over terrain

## Iteration 23 - 2026-01-25
Task: arcology-ak9.7 - Add background layer (sky/starfield)
Docs Consulted:
- documentation/game-design/environment/terrain.md#background-layer
- documentation/quick-reference/isometric-math.md
Status: PASSED
Changes:
- assets/sprites/terrain/backgrounds/*.png: 3 background sprites (2048x1536)
  - earth_sky.png: Blue gradient + mountain silhouettes
  - mars_sky.png: Orange-pink Martian atmosphere with dust
  - space_stars.png: Starfield with nebula effects
- scripts/generate_background_sprites.py: Python generator using Pillow
- src/core/terrain.gd: Added TextureRect background support
  - _background_color and _background_texture nodes (dual layer)
  - _update_background() loads texture or falls back to color
  - has_background_texture() accessor
  - Updated set_plane_size() for both background nodes
- test/test_terrain.gd: 7 new tests (20-26) for backgrounds
Learnings:
- TextureRect.EXPAND_IGNORE_SIZE + STRETCH_KEEP_ASPECT_COVERED fills viewport
- ResourceLoader.exists() must be called before load() for graceful fallback
- Texture z_index must be 1 higher than color fallback for proper layering
- 2048x1536 dimensions provide adequate coverage with camera movement
- Pillow lerp_color() useful for generating gradients programmatically

## Iteration 24 - 2026-01-25
Task: arcology-ak9.5 - Integrate Terrain into main scene
Docs Consulted:
- documentation/game-design/environment/terrain.md#grid-interaction
- documentation/architecture/milestones/milestone-1-grid-blocks.md
Status: PASSED
Changes:
- src/core/main.gd: Added terrain integration
  - Added terrain instance variable
  - Added _setup_terrain() called before _setup_grid()
  - Connected grid.block_added/block_removed to terrain visibility
  - Scatter decorations on 40x40 area at startup
- test/test_terrain_integration.gd: New test file
  - 12 integration tests for terrain-grid interaction
  - Tests: z_index, scatter, determinism, visibility, theme density
Learnings:
- Use world.move_child(terrain, 0) to ensure terrain renders first (behind blocks)
- Grid.block_removed only has one parameter (pos), not two like block_added
- Decorations hide/show at Z=0 when blocks added/removed at same X,Y
- Integration tests can verify scatter algorithm without full scene tree

## Iteration 25 - 2026-01-25
Task: arcology-ak9.6 - Implement river system (Earth theme)
Docs Consulted:
- documentation/game-design/environment/terrain.md#river-system
- documentation/quick-reference/isometric-math.md
Status: PASSED
Changes:
- assets/sprites/terrain/earth/river_tiles/*.png: 10 river tile sprites
- scripts/generate_river_sprites.py: Pillow-based sprite generator
- src/core/terrain.gd: River system (path generation, rendering, visibility)
- src/core/grid.gd: River obstacle checking for pathfinding
- src/core/main.gd: River integration with game scene
- data/terrain.json: River configuration with tile mappings
- test/test_river.gd: 23 unit tests
Learnings:
- River path generation uses winding algorithm with weighted movement toward target
- Use offset seed (world_seed + 999999) to ensure river differs from decoration scatter
- Corner tile selection requires tracking "from" direction (prev_dir) and "to" direction (next_dir)
- Sprites only render when Godot renderer is active (tile_count=0 in headless tests)
- River positions stored in Array[Vector2i] for O(n) path membership checks
- Use explicit type annotations for Dictionary.get() returns to avoid type inference errors
Followup:
- Bridge block type for crossing rivers (future milestone)
- Animated water effect (optional enhancement)

## Iteration 26 - 2026-01-25
Task: arcology-ak9.8 - Implement underground terrain (excavation visuals)
Docs Consulted:
- documentation/game-design/environment/terrain.md#underground-z--0
- documentation/game-design/economy/permits.md#excavation
Status: PASSED
Changes:
- scripts/generate_underground_sprites.py: New Pillow sprite generator for underground tiles
- assets/sprites/terrain/earth/underground/*.png: soil, rock, bedrock (3 sprites)
- assets/sprites/terrain/mars/underground/*.png: regolith, rock, basalt (3 sprites)
- src/core/terrain.gd: Added underground rendering system
  - generate_underground() creates tiles for Z < 0
  - update_underground_visibility() shows/hides based on current floor
  - hide/show/remove_underground_at() for excavation integration
  - Alpha dimming for depth (20% per level, min 40%)
- src/core/grid.gd: Added excavation tracking
  - excavate(), is_excavated(), can_place_at() methods
  - excavation_changed signal for terrain integration
  - Auto-excavation when placing blocks at Z < 0
  - Excavation persists after block removal
- data/terrain.json: Underground config per theme (layers by depth)
- test/test_underground.gd: 40 unit tests
Learnings:
- Use underground:null in JSON for themes without underground (space)
- Block placement can auto-excavate to simplify initial UX
- Excavation is permanent (realistic - can't un-dig)
- Different sprite per depth: Z=-1 soil, Z=-2 rock, Z=-3+ bedrock
- Use _find_nodes_by_class() helper to locate Grid from Terrain
Followup:
- Cross-section view rendering (nice-to-have)
- Excavation cost integration with economy system
- InputHandler UI for manual excavation mode

## Iteration 27 - 2026-01-25
Task: arcology-d1f.1 - Implement HUD Layout
Docs Consulted:
- documentation/ui/hud-layout.md (screen regions, colors, sizes)
- src/ui/block_picker.gd (existing UI pattern reference)
- src/ui/floor_selector.gd (existing UI pattern reference)
Status: PASSED
Changes:
- src/ui/hud.gd: New HUD class with full layout (TopBar, LeftSidebar, RightPanel, BottomBar)
- src/core/main.gd: Integrated HUD into main scene with floor sync
- test/test_hud.gd: 62 unit tests
- test/test_hud_integration.gd: 17 integration tests
Learnings:
- All containers need explicit .name assignments for get_node_or_null() paths to work
- Use mouse_filter = MOUSE_FILTER_IGNORE on HUD root to allow game viewport click-through
- StyleBoxFlat.new() for custom panel styling with bg_color and borders
- create_tween() for smooth panel collapse/expand animations
- Number formatting with commas requires manual string manipulation in GDScript
Followup:
- Connect build category buttons to block placement system
- Implement speed control button group toggle exclusivity
- Add overlay dropdown menu functionality
- Right panel auto-hide after 5s inactivity (per docs)

## Iteration 28 - 2026-01-25
Task: arcology-edz - Bug: Block placement stopped working
Docs Consulted:
- src/core/input_handler.gd
- src/core/block_renderer.gd
- src/ui/hud.gd
- scenes/main.tscn
Status: PASSED (likely already fixed or visual issue)
Changes:
- scenes/main.tscn: Added mouse_filter = 2 to DebugLabel
Learnings:
- Input.parse_input_event() can be used in tests to simulate mouse clicks
- InputHandler._unhandled_input receives events AFTER UI controls process them
- Controls with default mouse_filter (STOP) will capture clicks in their area
- Test via SceneTree _process can use multiple phases for frame-by-frame testing
- Block placement works correctly - tested with simulated clicks showing 11→12 blocks
Investigation Notes:
- InputHandler receives events and processes them correctly
- Block placement signal fires ("Placed corridor at ...")
- Grid block count increases after placement
- Bug may have been intermittent or visual (blocks placed but not rendered)

## Iteration 29 - 2026-01-25
Task: arcology-d1f.10 - Fix HUD anchoring for responsive screen sizes
Docs Consulted:
- documentation/ui/hud-layout.md (screen regions, responsive behavior)
- src/ui/hud.gd (current implementation)
Status: PASSED
Changes:
- src/ui/hud.gd: Already had fix (set_anchors_preset → set_anchors_and_offsets_preset)
- test/test_hud_anchoring.gd: New test file with 27 anchoring tests
Learnings:
- set_anchors_preset() only sets anchors without clearing offsets
- set_anchors_and_offsets_preset() sets anchors AND clears offsets to 0
- For Controls to fill viewport, both anchors AND zero offsets are needed
- Controls with non-equal anchors (PRESET_FULL_RECT) cannot have size set directly
- VBoxContainer children should have SIZE_EXPAND_FILL flag for middle section expansion

## Iteration 30 - 2026-01-25
Task: arcology-d1f.2 - Implement Build Toolbar
Docs Consulted:
- documentation/ui/build-toolbar.md (toolbar layout, category specs)
- documentation/ui/hud-layout.md (color scheme reference)
- data/blocks.json (existing block definitions)
- src/core/block_registry.gd (API for block lookup)
Status: PASSED
Changes:
- src/ui/build_toolbar.gd: New BuildToolbar class with 7 categories and flyout panel
- src/core/main.gd: Added _setup_build_toolbar() integration
- test/test_build_toolbar.gd: 76 unit tests
- test/test_build_toolbar_integration.gd: 12 integration tests
Learnings:
- BlockRegistry has get_types_by_category() for filtering blocks by category
- StyleBoxFlat for custom button/panel styling with corner_radius, border_width, bg_color
- Flyout positioning: use negative offsets to position above bottom bar
- VBoxContainer needs explicit name="VBoxContainer" for get_node() path to work
- Signal connections in tests: lambda captures may not work; use direct method calls
- ResourceLoader.exists() before load() for graceful missing sprite handling
Followup:
- Legacy BlockPicker still handles 1-6 keys (may conflict with BuildToolbar 1-7)
- R rotation and V variant cycling not implemented (requires block rotation system)

## Iteration 31 - 2026-01-26
Task: arcology-d1f.4 - Implement Info Panels
Docs Consulted:
- documentation/ui/info-panels.md (full panel specs)
- documentation/ui/hud-layout.md (color scheme, right panel structure)
Status: PASSED
Changes:
- src/ui/info_panel.gd: Base class with sections, bars, stats, headers, formatting
- src/ui/block_info_panel.gd: Block info with environment, economics, actions
- src/ui/resident_info_panel.gd: Notable/statistical residents, needs, relationships
- src/ui/budget_panel.gd: Income/expenses, trends sparklines, projections
- src/ui/aei_dashboard.gd: AEI score, components, tier colors, achievements
- src/ui/info_panel_manager.gd: Panel coordination, HUD integration
- src/core/input_handler.gd: Added Mode enum (BUILD, SELECT, DEMOLISH), block_selected signal
- src/core/main.gd: Integrated InfoPanelManager, connected signals for block selection
- test/test_*.gd: 6 test files with 143 total tests
Learnings:
- Dictionary.get() returns Variant - must use explicit type annotations (var x: int = dict.get("key", 0))
- HUD._ready() not called in tests since nodes aren't in scene tree - call manually for integration tests
- queue_free() schedules removal at end of frame - test cache state, not child count
- PanelContainer + StyleBoxFlat for consistent panel styling
- InfoPanel base class provides reusable create_bar(), create_stat_row(), create_header() helpers
- Color thresholds: green (>=70), yellow (40-70), red (<40) for progress bars
- AEI tiers: Bronze (80), Silver (90), Gold (95), Platinum (99)
Followup:
- Multi-select panel not implemented (shift+click selection system needed)
- $ keyboard shortcut for budget needs separate input handling
- Panel auto-close after inactivity (5s per docs) not implemented
- Actual data integration when resident/economy systems exist

## Iteration 32 - 2026-01-26
Task: arcology-d1f.5 - Implement Game Menus
Docs Consulted:
- documentation/ui/menus.md (full menu specifications)
- documentation/ui/hud-layout.md (color scheme, z-order)
Status: PASSED
Changes:
- src/ui/main_menu.gd: Title screen with New Game, Continue, Load, Settings, Credits, Quit
- src/ui/pause_menu.gd: Overlay with Resume, Save, Load, Settings, Help, Main Menu, Quit (Esc toggle)
- src/ui/settings_menu.gd: Tabbed interface (Game, Graphics, Audio, Controls, Accessibility)
- src/ui/new_game_menu.gd: Scenario selection (Fresh Start, Troubled Tower, Crisis Mode) + game settings
- src/ui/save_load_menu.gd: Save/load dialogs with filtering, sorting, auto-save detection
- src/ui/confirmation_dialog.gd: Modal dialogs for confirmations, errors, warnings, unsaved changes
- src/ui/menu_manager.gd: Coordinates menus, game state, navigation, auto-save integration
- src/core/auto_save.gd: Automatic save system (configurable interval, keeps last 3 auto-saves)
- test/test_*.gd: 7 test files (main_menu, pause_menu, settings_menu, new_game_menu, save_load_menu, confirmation_dialog, auto_save)
Learnings:
- Signal lambdas don't execute properly in SceneTree tests - verify signals via is_connected() instead
- grab_focus() fails outside scene tree - avoid in headless tests
- get_tree().process_frame requires scene tree for await - guard with null checks
- StyleBoxFlat.duplicate() for creating button hover/focus variants
- CanvasLayer with layer=100 for menus to appear above game
- JSON save format for game state persistence
Followup:
- Credits screen not implemented (placeholder TODO)
- Key rebinding UI ready but binding logic deferred
- MenuManager needs wiring into main.gd
- Help menu content not implemented

## Iteration 33 - 2026-01-26
Task: arcology-d1f.6 - Implement Time Controls
Docs Consulted:
- documentation/ui/sidebars.md (speed controls section)
- documentation/ui/controls.md (keyboard shortcuts)
- src/core/game_state.gd (existing state management)
- src/ui/hud.gd (UI integration patterns)
Status: PASSED
Changes:
- src/core/game_state.gd: Added time management (year/month/day/hour), speed control, pause system
- src/ui/time_controls.gd: New TimeControls UI component with date display, speed buttons, keyboard shortcuts
- src/ui/hud.gd: Integrated TimeControls, replaced old inline datetime/speed elements
- src/core/main.gd: Removed manual update_datetime call (handled by TimeControls)
- test/test_time_controls.gd: 14 unit tests for time system
- test/test_hud.gd: Updated for TimeControls integration
Learnings:
- GDScript lambda variable capture doesn't work reliably in unit tests - use state verification instead
- TimeControls._setup_ui() must be called manually in tests when not in scene tree (_ready doesn't fire)
- SPEED_NORMAL/FAST/FASTEST define seconds per game hour for time progression
- Use create_tween() with set_loops() for continuous animations (clock pulse)
- Scale pulse is effective visual feedback for speed indication
Followup:
- Hour display could be added to UI if needed (currently only shows Y/M/D)
- Clock rotation animation could be added for more visual polish

## Iteration 34 - 2026-01-26
Task: arcology-d1f.7 - Implement Floor Navigator
Docs Consulted:
- documentation/ui/sidebars.md (floor navigator section)
- src/ui/floor_selector.gd (existing legacy component)
- src/ui/hud.gd (UI integration patterns)
Status: PASSED
Changes:
- src/ui/floor_navigator.gd: New FloorNavigator component with popup floor list
- src/core/grid.gd: Added get_blocks_on_floor(), get_block_count_on_floor()
- src/ui/hud.gd: Integrated FloorNavigator, replaced inline floor elements
- test/test_floor_navigator.gd: 12 unit tests
- test/test_hud.gd: Updated for FloorNavigator integration
Learnings:
- Floor display format: F0 (G) for ground, F1-F10 for upper, B1-B2 for basement
- Ctrl+PageUp/Down for jump to top/ground floor
- E/C as alternate floor up/down keys (common in other games)
- Floor indicators: ● current, ◐ has content, ∅ empty
- Popup positioning needs screen edge checking (not implemented yet)
Followup:
- Floor activity indicators need resident simulation
- Floor alert indicators need notification system
- Smooth floor transition animation (visual polish)

## Iteration 35 - 2026-01-26
Task: arcology-d1f.8 - Implement Tool Sidebar
Docs Consulted:
- documentation/ui/sidebars.md (left sidebar section)
- src/ui/hud.gd (existing inline sidebar code)
Status: PASSED
Changes:
- src/ui/tool_sidebar.gd: New ToolSidebar component with collapse/expand, hover/pin
- src/ui/hud.gd: Integrated ToolSidebar, replaced inline left sidebar
- test/test_tool_sidebar.gd: 14 unit tests
- test/test_hud.gd: Updated for ToolSidebar integration
Learnings:
- Hover expand with Timer (300ms delay before expanding)
- Pin state prevents collapse on mouse exit
- Tool enum for type-safe tool selection: SELECT, BUILD, DEMOLISH, INFO, UPGRADE
- Recent blocks (Quick Build) limited to 5 unique entries
- Favorites limited to 10 entries
- _format_block_name() converts snake_case to [ABB] Title Case format
Followup:
- Tool selection needs connection to InputHandler
- Quick Build auto-population when blocks placed
- Favorites persistence needs save/load integration

## Iteration 36 - 2026-01-26
Task: arcology-d1f.9 - Implement Notification System
Docs Consulted:
- documentation/ui/sidebars.md (notification tray section)
- src/core/game_state.gd (pause integration)
- src/ui/time_controls.gd (UI component patterns)
Status: PASSED
Changes:
- src/ui/notification_system.gd: New autoload for notification management
- src/ui/notification_tray.gd: Badge button + expandable panel UI
- src/ui/toast_notification.gd: Slide-in toast notifications
- src/ui/hud.gd: Integrated NotificationTray in top bar
- src/core/main.gd: Added toast notification setup
- project.godot: Added NotificationSystem autoload
- test/ui/*.gd: 3 test files with 109 total tests
Learnings:
- Autoloads cannot have class_name (conflicts with singleton name)
- UI components can mirror autoload constants locally for self-contained behavior
- create_tween() requires scene tree, so tests may show animation as incomplete
- Emergency notifications should call GameState.toggle_pause() to auto-pause game
- Toast auto-dismiss uses get_tree().create_timer() which also requires scene tree
Followup:
- View action handler needs wiring (emits signal but no destination)
- Notification persistence needs save/load integration
- Panel height calculation could be refined for long lists

## Iteration 37 - 2026-01-26
Task: arcology-2pw - Camera controls like Cities Skylines
Docs Consulted:
- documentation/ui/controls.md (keyboard/mouse reference)
- src/core/main.gd (existing camera implementation)
Status: PASSED
Changes:
- src/core/camera_controller.gd: New CameraController class with enhanced controls
  - Smooth zoom with easing (zooms toward mouse position)
  - Middle-mouse and right-click drag panning
  - Double-click to center camera on clicked position
  - Q/E keys for 4-angle rotation (0°, 90°, 180°, 270°)
  - Shift+scroll for camera rotation
  - Home/End for zoom/position reset
  - Zoom adjusts pan speed inversely
  - Pan direction adjusts for camera rotation
- src/core/main.gd: Integrated CameraController via preload
- test/core/test_camera_controller.gd: 17 unit tests
Learnings:
- class_name works for classes but requires preload() to reference in other files
- Godot --import hangs in headless mode, use dynamic load() in tests instead
- Double-click detection needs manual tracking of last click time/position
- set_input_as_handled() prevents event from reaching other handlers
- lerp smoothing formula: position.lerp(target, factor * delta) where factor ~8-10 feels responsive
- wrapi() for circular index wrapping (e.g., rotation angle index)
- ROTATION_ANGLES array returns Variant, need explicit type annotation for subtraction
Followup:
- Edge scrolling (mouse at screen edge) not implemented - optional feature
- Zoom to selection (Z key) needs selection system first

