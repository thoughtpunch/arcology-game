## Codebase Patterns

(Add patterns discovered during development here. Future iterations will read this first.)

- Use Vector3i for grid positions (x, y = horizontal, z = floor level)
- All block types defined in data/blocks.json, not hardcoded
- Sprites go in assets/sprites/blocks/{category}/
- Signals over polling: blocks emit signals, systems connect to them
- Balance numbers loaded from data/balance.json at runtime
- AutoLoad scripts must NOT have class_name (use autoload name instead)
- Access autoloads via get_root().get_node("/root/AutoloadName")

---

## Iteration Log

(Ralph will append learnings after each iteration below)

## Iteration 1 - 2026-01-25
Task: arcology-4ct.1 - Create Godot 4 project structure
Status: PASSED
Changes:
- project.godot: Godot 4.3 config with input mappings
- scenes/main.tscn: Entry scene with Camera2D, World, UI
- src/core/main.gd: Camera pan/zoom controls
Learnings:
- Godot 4 uses config_version=5
- Camera2D zoom needs matching Vector2 components

## Iteration 2 - 2026-01-25
Task: arcology-4ct.2 - Add placeholder sprite
Status: PASSED
Changes:
- assets/sprites/blocks/placeholder.svg: 64x32 isometric diamond
- scenes/main.tscn: Added PlaceholderSprite node
Learnings:
- SVG works well for placeholder sprites in Godot 4

## Iteration 3 - 2026-01-25
Task: arcology-x0d.1 - Implement Grid class
Status: PASSED
Changes:
- src/core/grid.gd: Grid class with sparse 3D dictionary, isometric conversion, signals
- test/test_grid.gd: Unit tests for Grid class
Learnings:
- Grid extends Node (not RefCounted) so it can be added to scene tree
- Use roundi() for screen_to_grid to handle floating point precision
- TILE_DEPTH (32) is diamond height, FLOOR_HEIGHT (32) is Z offset
- grid_to_screen formula: x = (pos.x - pos.y) * 32, y = (pos.x + pos.y) * 16 - pos.z * 32
- screen_to_grid requires known Z level to invert correctly

## Iteration 4 - 2026-01-25
Task: arcology-x0d.4 - Create blocks.json data file
Status: PASSED
Changes:
- data/blocks.json: 6 block types for M1-M3
Learnings:
- Block schema: name, category, traversability, size, cost, sprite, connects_horizontal, connects_vertical
- entrance has ground_only: true (can only be placed on Z=0)
- stairs connects to Z+1 only; elevator connects full shaft
- private blocks (residential/commercial) have connects_horizontal: false

## Iteration 5 - 2026-01-25
Task: arcology-x0d.2 - Implement Block base class
Status: PASSED
Changes:
- src/blocks/block.gd: Block RefCounted class
- test/test_block.gd: Unit tests
Learnings:
- Block extends RefCounted (not Node) for lightweight data storage
- get_definition() looks up BlockRegistry via Engine.get_main_loop().get_node()
- property_changed signal uses property name string for reactive updates
- Graceful fallback when BlockRegistry not available (returns empty dict)
- Must run --import to generate .uid files for new scripts

## Iteration 6 - 2026-01-25
Task: arcology-x0d.3 - Implement BlockRegistry
Status: PASSED
Changes:
- src/core/block_registry.gd: BlockRegistry autoload
- project.godot: Added BlockRegistry to [autoload] section
- test/test_block_registry.gd: Unit tests
Learnings:
- AutoLoad scripts must NOT have class_name (conflicts with singleton name)
- Access autoload via get_root().get_node("/root/BlockRegistry")
- JSON.parse() returns error code, use get_data() for parsed result
- Helper methods (is_public, connects_vertical, etc.) keep Block class simple

## Iteration 7 - 2026-01-25
Task: arcology-x0d.8 - Create basic block sprites
Status: PASSED
Changes:
- assets/sprites/blocks/*.png: 6 isometric block sprites
- scripts/generate_sprites.py: Python sprite generator
Learnings:
- Pillow (PIL) can generate isometric sprites programmatically
- 64x64 hexagonal shape: top diamond + left wall + right wall
- Use RGBA mode for transparency
- Keep generator script for easy regeneration with different colors

## Iteration 8 - 2026-01-25
Task: arcology-x0d.5 - Setup isometric rendering with Y-sort
Status: PASSED
Changes:
- src/core/block_renderer.gd: BlockRenderer class for sprite management
- src/core/main.gd: Setup grid and renderer, test blocks
- scenes/main.tscn: Removed placeholder sprite
- test/test_renderer.gd: Unit tests
Learnings:
- BlockRenderer extends Node2D with y_sort_enabled = true
- Connect to Grid signals for reactive sprite creation/removal
- z_index formula: x + y + z*100 ensures proper floor stacking
- Cache loaded textures to avoid repeated load() calls
- Block types in code must match blocks.json keys exactly

## Iteration 9 - 2026-01-25
Task: arcology-x0d.6 - Implement block placement on click
Docs Consulted:
- documentation/quick-reference/isometric-math.md (screen_to_grid, mouse picking)
- documentation/architecture/milestones/milestone-1-grid-blocks.md (input handling)
Status: PASSED
Changes:
- src/core/input_handler.gd: InputHandler class for mouse input
- src/core/main.gd: Integrated InputHandler with setup
- test/test_input_handler.gd: Unit tests for placement/removal
Learnings:
- Use camera.get_canvas_transform().affine_inverse() * mouse_pos for world coords
- Ghost sprite needs z_index=1000 to always render on top
- Ghost modulate with Color(1,1,1,0.6) for valid, Color(1,0.3,0.3,0.6) for invalid
- _unhandled_input receives mouse events; _process handles ghost position updates
- Tests can run without scene tree if BlockRegistry lookup gracefully fails

## Iteration 10 - 2026-01-25
Task: arcology-x0d.7 - Create simple block picker UI
Docs Consulted:
- documentation/architecture/milestones/milestone-1-grid-blocks.md (UI requirements)
- documentation/game-design/blocks/README.md (block categories)
Status: PASSED
Changes:
- src/ui/block_picker.gd: BlockPicker Control class with HBoxContainer
- src/core/main.gd: Integrated BlockPicker with ui_layer
- test/test_block_picker.gd: Unit tests for selection
Learnings:
- Control anchors: anchor_top=1.0, anchor_bottom=1.0, offset_top=-60 for bottom panel
- Use toggle_mode=true on Button for visual pressed state
- Define BLOCK_ORDER constant array for consistent keyboard shortcuts (1-6)
- call_deferred("_populate_buttons") to wait for BlockRegistry autoload
- Connect block_type_selected signal to InputHandler.set_selected_block_type()

## Iteration 11 - 2026-01-25
Task: arcology-y6e.1 - Add floor selector UI
Docs Consulted:
- documentation/architecture/milestones/milestone-2-floor-navigation.md (Floor system spec)
Status: PASSED
Changes:
- src/core/game_state.gd: GameState autoload with floor state and signals
- src/ui/floor_selector.gd: FloorSelector UI with label and up/down buttons
- src/core/input_handler.gd: Now reads current_floor from GameState
- src/core/main.gd: Integrated FloorSelector with UI layer
- project.godot: Added GameState to autoloads
- test/test_game_state.gd: Unit tests for GameState
- test/test_floor_selector.gd: Unit tests for FloorSelector
Learnings:
- GameState autoload centralizes floor state for all systems
- FloorSelector handles PageUp/PageDown in _unhandled_input
- InputHandler gets current_floor via _get_current_floor() helper
- KEY_PAGEUP and KEY_PAGEDOWN are the keycode constants
- get_tree().get_root().get_node_or_null() for safe autoload access
Followup:
- Floor visibility (hiding floors above, fading floors below) is a separate task (y6e.2)

## Iteration 12 - 2026-01-25
Task: arcology-y6e.2 - Implement floor visibility system
Docs Consulted:
- documentation/architecture/milestones/milestone-2-floor-navigation.md (Visibility code sample)
- documentation/game-design/core-concepts.md (Z-level meaning)
Status: PASSED
Changes:
- src/core/block_renderer.gd: Added update_visibility() with cutaway view logic
- src/core/main.gd: Connected GameState.floor_changed to update visibility
- test/test_floor_visibility.gd: 8 unit tests (positive and negative assertions)
Learnings:
- Floor visibility constants: FLOORS_BELOW_VISIBLE=2, OPACITY_FALLOFF=0.3
- Opacity formula: 1.0 - (depth * 0.3) gives 100%, 70%, 40% for floors 0, -1, -2
- Connect to GameState.floor_changed signal for reactive updates
- Apply visibility to newly added blocks in _on_block_added handler
- Use get_node_or_null() for safe autoload access in methods called during initialization
Followup:
- Block placement on any floor (y6e.3) is next task in M2

## Iteration 13 - 2026-01-25
Task: arcology-y6e.3 - Enable block placement on any floor
Docs Consulted:
- documentation/architecture/milestones/milestone-2-floor-navigation.md (Placement on current floor)
- documentation/quick-reference/isometric-math.md (screen_to_grid with Z)
Status: PASSED
Changes:
- test/test_input_handler.gd: Fixed _test_floor_change to reflect GameState architecture
- test/test_multifloor_placement.gd: New integration test (8 tests) for multi-floor placement
Learnings:
- Feature was already implemented in InputHandler._get_current_floor() from y6e.1
- InputHandler reads current_floor from GameState autoload, not from own property
- Tests should use autoload integration tests for full coverage
- Test file test_multifloor_placement.gd covers: tower building, z-index ordering, entrance constraints
Followup:
- M2 Floor Navigation is now complete
- Next: M3 Connectivity tasks (adjacency detection, entrance block type)

## Iteration 14 - 2026-01-25
Task: arcology-itx.1 - Implement adjacency detection
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (Neighbor finding, connection rules)
- data/blocks.json (traversability, connects_horizontal/vertical properties)
Status: PASSED
Changes:
- src/core/grid.gd: Added adjacency methods
  - get_occupied_neighbors(): Returns neighbors with blocks
  - get_occupied_horizontal_neighbors(): Same floor only
  - can_connect(): Check walkability between blocks
  - get_walkable_neighbors(): Get reachable neighbors
- test/test_adjacency.gd: 12 unit tests
Learnings:
- Horizontal connection rule: at least one block must be public (traversable)
- Vertical connection rule: both blocks must have connects_vertical=true
- Private blocks are destinations, not through-routes (can reach, not traverse)
- Use explicit type annotations (: bool, : int) when calling registry methods to avoid type inference errors
- Registry methods return dynamic types, use explicit types not :=
Followup:
- Next M3 task: arcology-itx.3 (Add entrance block type)

## Iteration 15 - 2026-01-25
Task: arcology-itx.3 - Add entrance block type
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (Entrance as flood-fill seed)
- data/blocks.json (entrance definition already existed)
Status: PASSED
Changes:
- src/core/grid.gd: Added entrance tracking
  - _entrance_positions array tracks all entrance blocks
  - entrances_changed signal for connectivity recalculation
  - get_entrance_positions(), has_entrance() accessors
  - _track_entrance/_untrack_entrance on block add/remove
- test/test_entrance.gd: 10 unit tests
Learnings:
- Entrance block was already defined in blocks.json from iteration 4
- Ground_only enforcement was already in InputHandler
- Need to handle both Block objects and Dictionaries in tracking (for test compatibility)
- Use "block is Object and 'block_type' in block" pattern for safe property access
Followup:
- M3 flood-fill connectivity (itx.2) depends on this entrance tracking
- Next: Check remaining M3 tasks or continue with available tasks

## Iteration 16 - 2026-01-25
Task: arcology-itx.2 - Implement connectivity flood-fill
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (BFS algorithm, traversability rules)
- documentation/game-design/core-concepts.md (public vs private blocks)
- data/blocks.json (block type definitions)
Status: PASSED
Changes:
- src/core/grid.gd: Added BFS flood-fill connectivity algorithm
  - calculate_connectivity() performs BFS from all entrance positions
  - _is_block_public() checks traversability via registry or dict field
  - _set_block_connected() handles both Block objects and dictionaries
  - connectivity_changed signal for reactive updates
  - block_registry property for direct injection (testing)
  - Auto-recalculates on block add/remove via call_deferred
- test/test_connectivity.gd: 33 unit tests for BFS algorithm
- test/test_connectivity_integration.gd: 15 integration tests with BlockRegistry
Learnings:
- Traversability rules: PUBLIC blocks expand neighbors in BFS; PRIVATE blocks are destinations only
- Engine.get_main_loop() returns null inside SceneTree test scripts during _init
- For integration tests, set grid.block_registry directly rather than relying on autoload lookup
- When registry unavailable, check for explicit "traversability" field in Dictionary blocks
- Use call_deferred("calculate_connectivity") to ensure signals fire before recalc
Followup:
- M3 remaining tasks: visual feedback for unconnected blocks (warning icon, overlay)
- Elevator shaft connectivity needs stairs/elevator blocks tested thoroughly

## Iteration 17 - 2026-01-25
Task: arcology-itx.4 - Show connectivity warning on disconnected blocks
Docs Consulted:
- documentation/architecture/milestones/milestone-3-connectivity.md (visual feedback section)
Status: PASSED
Changes:
- src/core/block_renderer.gd: Added connectivity visual feedback
  - DISCONNECTED_TINT (red) and CONNECTED_TINT (white) constants
  - _on_connectivity_changed() connects to Grid signal
  - _update_connectivity_visual() applies tint based on block.connected
  - _update_sprite_visibility() preserves connectivity tint when updating alpha
- test/test_connectivity_visuals.gd: 10 unit tests for visual feedback
Learnings:
- Color modulate combines RGB tint with alpha for floor visibility
- Connect to Grid.connectivity_changed signal for reactive updates
- Type annotations required for inferred types like `var x := something.property`
Followup:
- Optional: Add 'C' key toggle for full connectivity overlay mode
- M3 complete: stairs and elevator already implemented in earlier iterations

## Iteration 18 - 2026-01-25
Task: arcology-itx.5 and arcology-itx.6 - Stairs and Elevator block types
Status: ALREADY IMPLEMENTED
Notes:
- Both block types already exist in data/blocks.json from iteration 4
- Sprites exist in assets/sprites/blocks/
- Vertical connectivity tested in test_connectivity_integration.gd
- Closed both tasks as already complete

M3 Connectivity & Paths COMPLETE:
- itx.1: Adjacency detection ✓
- itx.2: Connectivity flood-fill ✓
- itx.3: Entrance block type ✓
- itx.4: Connectivity visual warning ✓
- itx.5: Stairs block type ✓
- itx.6: Elevator shaft block type ✓

## Iteration 19 - 2026-01-25
Task: arcology-ak9.1 - Implement Terrain class with base plane rendering
Docs Consulted:
- documentation/game-design/environment/terrain.md (theme colors, z-index layers)
- documentation/quick-reference/isometric-math.md (sprite dimensions)
Status: PASSED
Changes:
- src/core/terrain.gd: New Terrain class extending Node2D
  - theme property with setter (earth, mars, space)
  - THEME_COLORS constant with Color values
  - Z_INDEX constants (background=-2000, base=-1000)
  - Base plane ColorRect at z_index -1000
  - Background ColorRect at z_index -2000
  - get_theme_color(), is_valid_theme(), get_available_themes()
  - set_plane_size() for map customization
- test/test_terrain.gd: 12 unit tests (positive and negative)
Learnings:
- ColorRect z_index is relative to parent when child
- Use setter with validation for theme property
- Space theme needs transparent Color(0,0,0,0) for base plane
- push_warning() for invalid theme input (not error)

